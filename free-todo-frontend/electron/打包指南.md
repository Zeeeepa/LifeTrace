# Electron åº”ç”¨æ‰“åŒ…æŒ‡å—

æœ¬æ–‡æ¡£æè¿°äº†å¦‚ä½•ä½¿ç”¨æœ€æ–°çš„æ–¹æ³•å°† Next.js + Electron åº”ç”¨æ‰“åŒ…ä¸ºç‹¬ç«‹çš„æ¡Œé¢åº”ç”¨ç¨‹åºã€‚

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ‰“åŒ…æµç¨‹è¯¦è§£](#æ‰“åŒ…æµç¨‹è¯¦è§£)
- [å…³é”®è„šæœ¬è¯´æ˜](#å…³é”®è„šæœ¬è¯´æ˜)
- [æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [æ„å»ºäº§ç‰©è¯´æ˜](#æ„å»ºäº§ç‰©è¯´æ˜)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### macOS æ‰“åŒ…

```bash
# æ¸…ç†ä¹‹å‰çš„æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼‰
rm -rf dist-electron-app dist-electron .next
# (å¦‚åœ¨ Windows PowerShell ä¸‹æ‰§è¡Œï¼Œå¯ç”¨ä»¥ä¸‹å‘½ä»¤)
Remove-Item -Recurse -Force dist-electron-app, dist-electron, .next

# æ‰§è¡Œ Mac æ‰“åŒ…
pnpm electron:build-mac
```

æ‰“åŒ…å®Œæˆåï¼ŒDMG æ–‡ä»¶å°†ç”Ÿæˆåœ¨ `dist-electron-app/` ç›®å½•ä¸‹ï¼š
- `FreeTodo-0.1.0-mac-x64.dmg` - Intel Mac ç‰ˆæœ¬
- `FreeTodo-0.1.0-mac-arm64.dmg` - Apple Silicon Mac ç‰ˆæœ¬

### Windows æ‰“åŒ…

```bash
pnpm electron:build-win
```

### Linux æ‰“åŒ…

```bash
pnpm electron:build-linux
```

## ğŸ“¦ æ‰“åŒ…æµç¨‹è¯¦è§£

å®Œæ•´çš„æ‰“åŒ…æµç¨‹åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼ŒæŒ‰é¡ºåºè‡ªåŠ¨æ‰§è¡Œï¼š

### 1. Next.js ç”Ÿäº§æ„å»º

```bash
pnpm build
```

**ä½œç”¨ï¼š**
- æ„å»º Next.js åº”ç”¨ä¸ºç”Ÿäº§ç‰ˆæœ¬
- ç”Ÿæˆ standalone è¾“å‡ºï¼ˆåŒ…å« `server.js` å’Œè¿è¡Œæ—¶æ–‡ä»¶ï¼‰
- ç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆCSSã€JS chunksï¼‰åˆ° `.next/static`
- ç”ŸæˆæœåŠ¡å™¨ç«¯æ–‡ä»¶åˆ° `.next/server`

**è¾“å‡ºï¼š**
- `.next/standalone/` - ç‹¬ç«‹çš„æœåŠ¡å™¨æ–‡ä»¶
- `.next/static/` - é™æ€èµ„æºæ–‡ä»¶
- `.next/server/` - æœåŠ¡å™¨ç«¯ä»£ç 

### 2. åç«¯æ‰“åŒ…ï¼ˆPyInstallerï¼‰

```bash
pnpm backend:build  # macOS/Linux
# æˆ–
pnpm backend:build:win  # Windows
```

**ä½œç”¨ï¼š**
- ä½¿ç”¨ PyInstaller å°† Python åç«¯æ‰“åŒ…ä¸ºç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
- åŒ…å«æ‰€æœ‰ Python ä¾èµ–å’Œè¿è¡Œæ—¶
- å¤åˆ¶é…ç½®æ–‡ä»¶å’Œæ¨¡å‹æ–‡ä»¶åˆ° app æ ¹ç›®å½•

**è¾“å‡ºï¼š**
- `../dist-backend/lifetrace` - åç«¯å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆmacOS/Linuxï¼‰
- `../dist-backend/lifetrace.exe` - åç«¯å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆWindowsï¼‰
- `../dist-backend/_internal/` - PyInstaller ä¾èµ–ç›®å½•
- `../dist-backend/config/` - é…ç½®æ–‡ä»¶ï¼ˆä¸ _internal åŒçº§åˆ«ï¼‰
- `../dist-backend/models/` - ONNX æ¨¡å‹æ–‡ä»¶ï¼ˆä¸ _internal åŒçº§åˆ«ï¼‰

**æ„å»ºè„šæœ¬ï¼š**
- macOS/Linux: `lifetrace/scripts/build-backend.sh`
- Windows: `lifetrace/scripts/build-backend.ps1`

**é‡è¦è¯´æ˜ï¼š**
- é…ç½®æ–‡ä»¶ï¼ˆ`default_config.yaml`, `prompt.yaml`, `rapidocr_config.yaml`ï¼‰å’Œæ¨¡å‹æ–‡ä»¶ä¼šè¢«å¤åˆ¶åˆ° app æ ¹ç›®å½•ï¼Œè€Œä¸æ˜¯ `_internal` ç›®å½•å†…
- è¿™æ ·åœ¨æ‰“åŒ…ç¯å¢ƒä¸­ï¼Œè·¯å¾„ä¸º `backend/config/` å’Œ `backend/models/`ï¼ˆä¸ `_internal` åŒçº§åˆ«ï¼‰

### 3. è§£æç¬¦å·é“¾æ¥

```bash
pnpm electron:resolve-symlinks
```

**ä½œç”¨ï¼š**
- è§£æ pnpm åœ¨ `node_modules` ä¸­åˆ›å»ºçš„ç¬¦å·é“¾æ¥
- å°†ç¬¦å·é“¾æ¥æ›¿æ¢ä¸ºå®é™…çš„æ–‡ä»¶/ç›®å½•
- ç¡®ä¿æ‰“åŒ…åçš„åº”ç”¨å¯ä»¥æ­£ç¡®æ‰¾åˆ°æ‰€æœ‰ä¾èµ–

**ä¸ºä»€ä¹ˆéœ€è¦ï¼š**
- pnpm ä½¿ç”¨ç¬¦å·é“¾æ¥æ¥èŠ‚çœç£ç›˜ç©ºé—´ï¼ˆ`.pnpm` ç»“æ„ï¼‰
- æ‰“åŒ…åçš„åº”ç”¨å¯èƒ½æ— æ³•æ­£ç¡®è§£æè¿™äº›ç¬¦å·é“¾æ¥
- éœ€è¦å°†ç¬¦å·é“¾æ¥è½¬æ¢ä¸ºå®é™…æ–‡ä»¶

**è„šæœ¬ä½ç½®ï¼š** `scripts/resolve-symlinks.js`

### 4. å¤åˆ¶ç¼ºå¤±çš„ä¾èµ–

```bash
pnpm electron:copy-missing-deps
```

**ä½œç”¨ï¼š**
- å¤åˆ¶ Next.js standalone æ„å»ºä¸­ç¼ºå¤±çš„è¿è¡Œæ—¶ä¾èµ–
- è¿™äº›ä¾èµ–æ˜¯ Next.js å†…éƒ¨ä½¿ç”¨çš„ï¼Œä½† standalone æ„å»ºå¯èƒ½ä¸ä¼šè‡ªåŠ¨åŒ…å«

**å½“å‰å¤åˆ¶çš„ä¾èµ–ï¼š**
- `styled-jsx` - CSS-in-JS è¿è¡Œæ—¶
- `@swc/helpers` - SWC ç¼–è¯‘å™¨è¾…åŠ©å‡½æ•°
- `@next/env` - Next.js ç¯å¢ƒå˜é‡å¤„ç†
- `client-only` - å®¢æˆ·ç«¯ä¸“ç”¨æ ‡è®°
- `buffer-from` - Buffer å·¥å…·
- `detect-libc` - åº“æ£€æµ‹å·¥å…·

**è„šæœ¬ä½ç½®ï¼š** `scripts/copy-missing-deps.js`

**å¦‚ä½•æ·»åŠ æ›´å¤šä¾èµ–ï¼š**
ç¼–è¾‘ `scripts/copy-missing-deps.js`ï¼Œåœ¨ `missingDeps` æ•°ç»„ä¸­æ·»åŠ ä¾èµ–åç§°ã€‚

### 5. ç¼–è¯‘ Electron ä¸»è¿›ç¨‹

```bash
pnpm electron:build-main
```

**ä½œç”¨ï¼š**
- ä½¿ç”¨ esbuild å°† TypeScript ä¸»è¿›ç¨‹ä»£ç ç¼–è¯‘ä¸º JavaScript
- è¾“å‡ºåˆ° `dist-electron/main.js`

**è„šæœ¬ä½ç½®ï¼š** `scripts/build-electron.js`

### 6. æ‰“åŒ…åº”ç”¨

```bash
electron-builder --mac  # æˆ– --win, --linux
```

**ä½œç”¨ï¼š**
- ä½¿ç”¨ electron-builder åˆ›å»ºå¹³å°ç‰¹å®šçš„å®‰è£…åŒ…
- å°† Next.js standalone æ„å»ºã€é™æ€æ–‡ä»¶ã€ä¸»è¿›ç¨‹ä»£ç ã€åç«¯å¯æ‰§è¡Œæ–‡ä»¶æ‰“åŒ…åœ¨ä¸€èµ·
- ç”Ÿæˆ DMGï¼ˆmacOSï¼‰ã€NSIS/Portableï¼ˆWindowsï¼‰æˆ– AppImageï¼ˆLinuxï¼‰

**é…ç½®æ–‡ä»¶ï¼š** `electron-builder.yml`

**æ‰“åŒ…åçš„ç›®å½•ç»“æ„ï¼š**
```
FreeTodo.app/Contents/Resources/
â”œâ”€â”€ app/                    # Electron ä¸»åº”ç”¨
â”œâ”€â”€ backend/                # Python åç«¯ï¼ˆPyInstaller æ‰“åŒ…ï¼‰
â”‚   â”œâ”€â”€ lifetrace          # åç«¯å¯æ‰§è¡Œæ–‡ä»¶
â”‚   â”œâ”€â”€ _internal/         # PyInstaller ä¾èµ–
â”‚   â”œâ”€â”€ config/            # é…ç½®æ–‡ä»¶ï¼ˆdefault_config.yaml, prompt.yaml, rapidocr_config.yamlï¼‰
â”‚   â””â”€â”€ models/            # ONNX æ¨¡å‹æ–‡ä»¶
â””â”€â”€ standalone/            # Next.js standalone æœåŠ¡å™¨
```

## ğŸ”§ å…³é”®è„šæœ¬è¯´æ˜

### `lifetrace/scripts/build-backend.sh` / `build-backend.ps1`

**åŠŸèƒ½ï¼š** ä½¿ç”¨ PyInstaller æ‰“åŒ… Python åç«¯

**å·¥ä½œåŸç†ï¼š**
1. ä½¿ç”¨ PyInstaller æ ¹æ® `pyinstaller.spec` é…ç½®æ‰“åŒ…
2. å°†å¯æ‰§è¡Œæ–‡ä»¶å’Œä¾èµ–å¤åˆ¶åˆ° `dist-backend/`
3. **é‡è¦ï¼š** å°† `config` å’Œ `models` ä» `_internal/` å¤åˆ¶åˆ° app æ ¹ç›®å½•ï¼ˆä¸ `_internal` åŒçº§åˆ«ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦å¤åˆ¶ config å’Œ modelsï¼Ÿ**
- PyInstaller é»˜è®¤å°†æ‰€æœ‰æ•°æ®æ–‡ä»¶æ”¾åœ¨ `_internal/` ç›®å½•
- ä½†ä¸ºäº†è·¯å¾„è§£æçš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å°†å®ƒä»¬æ”¾åœ¨ app æ ¹ç›®å½•
- è¿™æ ·åœ¨å¼€å‘ç¯å¢ƒå’Œæ‰“åŒ…ç¯å¢ƒä¸­ï¼Œè·¯å¾„é€»è¾‘ä¿æŒä¸€è‡´

### `scripts/resolve-symlinks.js`

**åŠŸèƒ½ï¼š** é€’å½’è§£æ `node_modules` ä¸­çš„æ‰€æœ‰ç¬¦å·é“¾æ¥

**å·¥ä½œåŸç†ï¼š**
1. éå† `.next/standalone/node_modules` ç›®å½•
2. æ£€æµ‹ç¬¦å·é“¾æ¥
3. è¯»å–ç¬¦å·é“¾æ¥ç›®æ ‡
4. åˆ é™¤ç¬¦å·é“¾æ¥
5. å¤åˆ¶ç›®æ ‡æ–‡ä»¶/ç›®å½•åˆ°åŸä½ç½®

**æ³¨æ„äº‹é¡¹ï¼š**
- å¦‚æœç¬¦å·é“¾æ¥ç›®æ ‡ä¸å­˜åœ¨ï¼Œä¼šè¾“å‡ºè­¦å‘Šä½†ç»§ç»­å¤„ç†
- é€’å½’å¤„ç†æ‰€æœ‰å­ç›®å½•

### `scripts/copy-missing-deps.js`

**åŠŸèƒ½ï¼š** ä»ä¸» `node_modules/.pnpm` å¤åˆ¶ç¼ºå¤±çš„ä¾èµ–åˆ° standalone æ„å»º

**å·¥ä½œåŸç†ï¼š**
1. éå†éœ€è¦å¤åˆ¶çš„ä¾èµ–åˆ—è¡¨
2. åœ¨ `.pnpm` ç›®å½•ä¸­æŸ¥æ‰¾ä¾èµ–ï¼ˆå¤„ç† scoped packagesï¼š`@scope/package` â†’ `@scope+package`ï¼‰
3. å¤åˆ¶ä¾èµ–åˆ° standalone çš„ `node_modules` ç›®å½•

**å¦‚ä½•æ·»åŠ æ–°ä¾èµ–ï¼š**
```javascript
const missingDeps = [
  "styled-jsx",
  "@swc/helpers",
  "your-new-dependency", // æ·»åŠ åˆ°è¿™é‡Œ
]
```

## âš ï¸ æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 0: åç«¯å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶ï¼š**
- åº”ç”¨å¯åŠ¨åï¼Œåç«¯æœåŠ¡å™¨æ— æ³•å¯åŠ¨
- æ—¥å¿—æ˜¾ç¤º "Backend server exited unexpectedly"
- æˆ– "The backend executable was not found"

**å¯èƒ½åŸå› ï¼š**
1. åç«¯å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„é”™è¯¯
2. åç«¯å¯æ‰§è¡Œæ–‡ä»¶æ²¡æœ‰æ‰§è¡Œæƒé™
3. é…ç½®æ–‡ä»¶æˆ–æ¨¡å‹æ–‡ä»¶ç¼ºå¤±
4. Python ä¾èµ–æœªæ­£ç¡®æ‰“åŒ…

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥åç«¯å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   ls -la dist-electron-app/mac/FreeTodo.app/Contents/Resources/backend/lifetrace
   # æˆ–
   ls -la /Applications/FreeTodo.app/Contents/Resources/backend/lifetrace
   ```

2. æ£€æŸ¥æ‰§è¡Œæƒé™ï¼š
   ```bash
   chmod +x /Applications/FreeTodo.app/Contents/Resources/backend/lifetrace
   ```

3. æ£€æŸ¥é…ç½®å’Œæ¨¡å‹æ–‡ä»¶ï¼š
   ```bash
   ls -la /Applications/FreeTodo.app/Contents/Resources/backend/config/
   ls -la /Applications/FreeTodo.app/Contents/Resources/backend/models/
   ```

4. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š
   ```bash
   # Electron æ—¥å¿—ï¼ˆåŒ…å«åç«¯è¾“å‡ºï¼‰
   tail -100 ~/Library/Logs/free-todo-frontend/freetodo.log | grep -i backend

   # åç«¯åº”ç”¨æ—¥å¿—
   tail -100 ~/Library/Application\ Support/free-todo-frontend/lifetrace-data/logs/*.log
   ```

5. ä½¿ç”¨è¯Šæ–­è„šæœ¬ï¼š
   ```bash
   cd free-todo-frontend
   bash scripts/diagnose.sh
   ```

6. æ‰‹åŠ¨æµ‹è¯•åç«¯ï¼š
   ```bash
   cd /Applications/FreeTodo.app/Contents/Resources/backend
   ./lifetrace --help
   ```

**ç›¸å…³æ–‡æ¡£ï¼š** è¯¦è§ `electron/åç«¯å¯åŠ¨æ£€æŸ¥æŒ‡å—.md`

### é—®é¢˜ 1: Next.js æœåŠ¡å™¨ç«‹å³é€€å‡ºï¼ˆcode 0ï¼‰

**ç—‡çŠ¶ï¼š**
- åº”ç”¨å¯åŠ¨åï¼ŒNext.js æœåŠ¡å™¨ç«‹å³é€€å‡º
- æ—¥å¿—æ˜¾ç¤º "Server exited unexpectedly with code 0"
- STDOUT å’Œ STDERR éƒ½æ˜¯ç©ºçš„

**å¯èƒ½åŸå› ï¼š**
1. ç¼ºå°‘è¿è¡Œæ—¶ä¾èµ–ï¼ˆå¦‚ `styled-jsx`ã€`@swc/helpers`ï¼‰
2. ç¬¦å·é“¾æ¥æœªæ­£ç¡®è§£æ
3. `node_modules` æœªæ­£ç¡®å¤åˆ¶åˆ°æ‰“åŒ…çš„åº”ç”¨ä¸­

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿ `electron:resolve-symlinks` å’Œ `electron:copy-missing-deps` éƒ½å·²æ‰§è¡Œ
2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼š`~/Library/Logs/free-todo-frontend/freetodo.log`
3. æ‰‹åŠ¨æµ‹è¯•æœåŠ¡å™¨ï¼š
   ```bash
   cd dist-electron-app/mac/FreeTodo.app/Contents/Resources/standalone
   PORT=3000 HOSTNAME=localhost NODE_ENV=production node server.js
   ```
4. å¦‚æœå‡ºç° "Cannot find module" é”™è¯¯ï¼Œå°†è¯¥æ¨¡å—æ·»åŠ åˆ° `copy-missing-deps.js` çš„ä¾èµ–åˆ—è¡¨

### é—®é¢˜ 2: CSS æ ·å¼ä¸¢å¤±

**ç—‡çŠ¶ï¼š**
- åº”ç”¨ç•Œé¢æ²¡æœ‰æ ·å¼
- é¡µé¢æ˜¾ç¤ºä¸ºçº¯æ–‡æœ¬

**å¯èƒ½åŸå› ï¼š**
- `.next/static` ç›®å½•æœªæ­£ç¡®å¤åˆ¶åˆ°æ‰“åŒ…çš„åº”ç”¨ä¸­

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `electron-builder.yml` ä¸­çš„ `extraResources` é…ç½®
2. ç¡®ä¿åŒ…å«ï¼š
   ```yaml
   - from: '.next/static'
     to: 'standalone/.next/static'
   ```
3. éªŒè¯æ‰“åŒ…åçš„åº”ç”¨ä¸­æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   ls dist-electron-app/mac/FreeTodo.app/Contents/Resources/standalone/.next/static
   ```

### é—®é¢˜ 3: å¤šä¸ªåº”ç”¨å®ä¾‹åŒæ—¶å¯åŠ¨

**ç—‡çŠ¶ï¼š**
- ç‚¹å‡»å¯åŠ¨å¤šæ¬¡åï¼Œå¤šä¸ªåº”ç”¨çª—å£åŒæ—¶å‡ºç°
- å¯èƒ½å¯¼è‡´ç«¯å£å†²çª

**è§£å†³æ–¹æ¡ˆï¼š**
- å·²å®ç°å•å®ä¾‹é”æœºåˆ¶ï¼ˆ`app.requestSingleInstanceLock()`ï¼‰
- å¦‚æœä»æœ‰é—®é¢˜ï¼Œæ£€æŸ¥ `electron/main.ts` ä¸­çš„å•å®ä¾‹å¤„ç†é€»è¾‘

### é—®é¢˜ 4: EPIPE é”™è¯¯

**ç—‡çŠ¶ï¼š**
- æ—¥å¿—ä¸­å‡ºç° "Error: write EPIPE"
- é€šå¸¸å‘ç”Ÿåœ¨è¿›ç¨‹é€€å‡ºæ—¶

**è§£å†³æ–¹æ¡ˆï¼š**
- å·²åœ¨ä»£ç ä¸­æ·»åŠ  EPIPE é”™è¯¯å¤„ç†
- ä½¿ç”¨å®‰å…¨çš„ I/O æ–¹æ³•ï¼ˆ`process.stdout.write` è€Œä¸æ˜¯ `console.log`ï¼‰
- åœ¨è¿›ç¨‹é€€å‡ºå¤„ç†ä¸­é¿å…å†™å…¥å·²å…³é—­çš„ç®¡é“

### é—®é¢˜ 5: ç¬¦å·é“¾æ¥è§£æå¤±è´¥

**ç—‡çŠ¶ï¼š**
- æ„å»ºè¿‡ç¨‹ä¸­å‡ºç° "Symlink target not found" è­¦å‘Š
- æŸäº›ä¾èµ–æ— æ³•æ‰¾åˆ°

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿åœ¨ `pnpm build` ä¹‹åç«‹å³è¿è¡Œ `resolve-symlinks`
2. æ£€æŸ¥ `.next/standalone/node_modules/.pnpm` ç›®å½•æ˜¯å¦å­˜åœ¨
3. å¦‚æœæŸäº›ç¬¦å·é“¾æ¥ç›®æ ‡ä¸å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦é‡æ–°æ„å»ºï¼š
   ```bash
   rm -rf .next
   pnpm build
   pnpm electron:resolve-symlinks
   ```

### é—®é¢˜ 6: æ‰“åŒ…åçš„åº”ç”¨æ— æ³•æ‰¾åˆ°æ¨¡å—

**ç—‡çŠ¶ï¼š**
- è¿è¡Œæ—¶é”™è¯¯ï¼š`Cannot find module 'xxx'`
- æœåŠ¡å™¨æ— æ³•å¯åŠ¨

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥è¯¥æ¨¡å—æ˜¯å¦åœ¨ `copy-missing-deps.js` çš„ä¾èµ–åˆ—è¡¨ä¸­
2. æ‰‹åŠ¨æµ‹è¯•æ¨¡å—æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   ls dist-electron-app/mac/FreeTodo.app/Contents/Resources/standalone/node_modules/æ¨¡å—å
   ```
3. å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ° `copy-missing-deps.js` å¹¶é‡æ–°æ‰“åŒ…

### é—®é¢˜ 7: æ„å»ºäº§ç‰©è¿‡å¤§

**ç—‡çŠ¶ï¼š**
- DMG æ–‡ä»¶è¶…è¿‡ 200MB

**åŸå› ï¼š**
- åŒ…å«å®Œæ•´çš„ `node_modules` ç›®å½•ï¼ˆçº¦ 140MBï¼‰
- åŒ…å« Next.js standalone æ„å»ºçš„æ‰€æœ‰æ–‡ä»¶
- åŒ…å« Electron è¿è¡Œæ—¶

**ä¼˜åŒ–å»ºè®®ï¼š**
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºåº”ç”¨æ˜¯å®Œå…¨ç‹¬ç«‹çš„
- å¦‚æœéœ€è¦å‡å°ä½“ç§¯ï¼Œå¯ä»¥è€ƒè™‘ï¼š
  1. ç§»é™¤æœªä½¿ç”¨çš„ä¾èµ–
  2. ä½¿ç”¨ä»£ç åˆ†å‰²
  3. å‹ç¼©èµ„æºæ–‡ä»¶

## ğŸ” æ•…éšœæ’æŸ¥

### æ£€æŸ¥æ—¥å¿—æ–‡ä»¶

**Electron ä¸»è¿›ç¨‹æ—¥å¿—ï¼š**
- **macOS:** `~/Library/Logs/free-todo-frontend/freetodo.log`
- **Windows:** `%APPDATA%/free-todo-frontend/logs/freetodo.log`
- **Linux:** `~/.config/free-todo-frontend/logs/freetodo.log`

**åç«¯åº”ç”¨æ—¥å¿—ï¼š**
- **macOS:** `~/Library/Application Support/free-todo-frontend/lifetrace-data/logs/`
- **Windows:** `%APPDATA%/free-todo-frontend/lifetrace-data/logs/`
- **Linux:** `~/.config/free-todo-frontend/lifetrace-data/logs/`

**å¿«é€ŸæŸ¥çœ‹æ—¥å¿—ï¼š**
```bash
# ä½¿ç”¨é¡¹ç›®æä¾›çš„è„šæœ¬ï¼ˆåŒæ—¶æŸ¥çœ‹ Electron å’Œåç«¯æ—¥å¿—ï¼‰
cd free-todo-frontend
bash scripts/view-logs.sh

# æˆ–ç›´æ¥æŸ¥çœ‹ Electron æ—¥å¿—
tail -100 ~/Library/Logs/free-todo-frontend/freetodo.log

# æŸ¥çœ‹åç«¯æ—¥å¿—
tail -100 ~/Library/Application\ Support/free-todo-frontend/lifetrace-data/logs/*.log
```

### æ£€æŸ¥åç«¯çŠ¶æ€

**æ–¹æ³• 1ï¼šæŸ¥çœ‹è¿›ç¨‹**
```bash
ps aux | grep lifetrace
lsof -i :8000
```

**æ–¹æ³• 2ï¼šæµ‹è¯•å¥åº·ç«¯ç‚¹**
```bash
curl http://localhost:8000/health
```

**æ–¹æ³• 3ï¼šä½¿ç”¨è¯Šæ–­è„šæœ¬**
```bash
cd free-todo-frontend
bash scripts/diagnose.sh
```

**æ–¹æ³• 4ï¼šæŸ¥çœ‹ Electron æ—¥å¿—ä¸­çš„åç«¯ä¿¡æ¯**
```bash
tail -100 ~/Library/Logs/free-todo-frontend/freetodo.log | grep -i backend
```

æŸ¥æ‰¾å…³é”®ä¿¡æ¯ï¼š
- `Starting backend server...` - å¼€å§‹å¯åŠ¨åç«¯
- `Backend server is ready!` - åç«¯å¯åŠ¨æˆåŠŸ
- `[Backend STDOUT]` / `[Backend STDERR]` - åç«¯è¾“å‡º
- `Backend health check passed` - åç«¯å¥åº·æ£€æŸ¥é€šè¿‡

### æ‰‹åŠ¨æµ‹è¯•æœåŠ¡å™¨

1. æ‰¾åˆ°æ‰“åŒ…åçš„åº”ç”¨ï¼š
   ```bash
   # macOS
   cd dist-electron-app/mac/FreeTodo.app/Contents/Resources/standalone

   # æˆ–ç›´æ¥æ‰“å¼€ DMG å
   cd /Applications/FreeTodo.app/Contents/Resources/standalone
   ```

2. æ‰‹åŠ¨å¯åŠ¨æœåŠ¡å™¨ï¼š
   ```bash
   PORT=3000 HOSTNAME=localhost NODE_ENV=production node server.js
   ```

3. æ£€æŸ¥è¾“å‡ºï¼š
   - å¦‚æœæœåŠ¡å™¨æ­£å¸¸å¯åŠ¨ï¼Œåº”è¯¥çœ‹åˆ° "Ready in XXms"
   - å¦‚æœæœ‰é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ä¼šç›´æ¥æ˜¾ç¤ºåœ¨ç»ˆç«¯

### éªŒè¯ä¾èµ–å®Œæ•´æ€§

æ£€æŸ¥å…³é”®ä¾èµ–æ˜¯å¦å­˜åœ¨ï¼š
```bash
cd dist-electron-app/mac/FreeTodo.app/Contents/Resources/standalone

# æ£€æŸ¥ Next.js
test -d node_modules/next && echo "âœ“ Next.js found" || echo "âœ— Next.js missing"

# æ£€æŸ¥ styled-jsx
test -d node_modules/styled-jsx && echo "âœ“ styled-jsx found" || echo "âœ— styled-jsx missing"

# æ£€æŸ¥ @swc/helpers
test -d node_modules/@swc/helpers && echo "âœ“ @swc/helpers found" || echo "âœ— @swc/helpers missing"
```

### æ£€æŸ¥æ–‡ä»¶ç»“æ„

éªŒè¯æ‰“åŒ…åçš„åº”ç”¨ç»“æ„ï¼š
```bash
cd dist-electron-app/mac/FreeTodo.app/Contents/Resources/standalone

# åº”è¯¥çœ‹åˆ°ä»¥ä¸‹ç›®å½•ï¼š
# - server.js (Next.js æœåŠ¡å™¨å…¥å£)
# - node_modules/ (æ‰€æœ‰ä¾èµ–)
# - .next/ (Next.js æ„å»ºæ–‡ä»¶)
#   - server/ (æœåŠ¡å™¨ç«¯ä»£ç )
#   - static/ (é™æ€èµ„æº)
# - public/ (å…¬å…±èµ„æº)
```

## ğŸ“¦ æ„å»ºäº§ç‰©è¯´æ˜

### macOS

**è¾“å‡ºæ–‡ä»¶ï¼š**
- `FreeTodo-0.1.0-mac-x64.dmg` - Intel Mac å®‰è£…åŒ…
- `FreeTodo-0.1.0-mac-arm64.dmg` - Apple Silicon Mac å®‰è£…åŒ…
- `*.dmg.blockmap` - å¢é‡æ›´æ–°æ˜ å°„æ–‡ä»¶

**å®‰è£…ä½ç½®ï¼š**
- åº”ç”¨å®‰è£…åœ¨ï¼š`/Applications/FreeTodo.app`
- Next.js èµ„æºåœ¨ï¼š`/Applications/FreeTodo.app/Contents/Resources/standalone`
- åç«¯å¯æ‰§è¡Œæ–‡ä»¶åœ¨ï¼š`/Applications/FreeTodo.app/Contents/Resources/backend/lifetrace`
- åç«¯é…ç½®æ–‡ä»¶åœ¨ï¼š`/Applications/FreeTodo.app/Contents/Resources/backend/config/`
- åç«¯æ¨¡å‹æ–‡ä»¶åœ¨ï¼š`/Applications/FreeTodo.app/Contents/Resources/backend/models/`

**ç”¨æˆ·æ•°æ®ç›®å½•ï¼š**
- macOS: `~/Library/Application Support/free-todo-frontend/lifetrace-data/`
  - `config/` - ç”¨æˆ·é…ç½®æ–‡ä»¶
  - `data/` - æ•°æ®åº“å’Œæˆªå›¾
  - `logs/` - åç«¯åº”ç”¨æ—¥å¿—

### Windows

**è¾“å‡ºæ–‡ä»¶ï¼š**
- `FreeTodo-0.1.0-win-x64.exe` - NSIS å®‰è£…ç¨‹åº
- `FreeTodo-0.1.0-portable.exe` - ä¾¿æºç‰ˆï¼ˆæ— éœ€å®‰è£…ï¼‰

### Linux

**è¾“å‡ºæ–‡ä»¶ï¼š**
- `FreeTodo-0.1.0-linux-x64.AppImage` - AppImage æ ¼å¼ï¼ˆæ— éœ€å®‰è£…ï¼‰

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ¸…ç†æ„å»ºç¼“å­˜

å¦‚æœé‡åˆ°å¥‡æ€ªçš„æ„å»ºé—®é¢˜ï¼Œå…ˆæ¸…ç†ï¼š
```bash
rm -rf dist-electron-app dist-electron .next
pnpm electron:build-mac
```

### 2. æ£€æŸ¥ä¾èµ–æ›´æ–°

å¦‚æœæ·»åŠ äº†æ–°çš„ npm ä¾èµ–ï¼Œå¯èƒ½éœ€è¦ï¼š
1. æ£€æŸ¥è¯¥ä¾èµ–æ˜¯å¦éœ€è¦åœ¨è¿è¡Œæ—¶å¯ç”¨
2. å¦‚æœæ˜¯ Next.js å†…éƒ¨ä½¿ç”¨çš„ä¾èµ–ï¼Œæ·»åŠ åˆ° `copy-missing-deps.js`
3. é‡æ–°æ„å»ºå’Œæ‰“åŒ…

### 3. æµ‹è¯•æ‰“åŒ…åçš„åº”ç”¨

**é‡è¦ï¼š** å§‹ç»ˆæµ‹è¯•æ‰“åŒ…åçš„åº”ç”¨ï¼Œè€Œä¸æ˜¯å¼€å‘ç‰ˆæœ¬ï¼š
1. å®‰è£… DMGï¼ˆmacOSï¼‰æˆ–è¿è¡Œå®‰è£…ç¨‹åºï¼ˆWindowsï¼‰
2. å¯åŠ¨åº”ç”¨
3. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ç¡®è®¤æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨
4. æµ‹è¯•ä¸»è¦åŠŸèƒ½

### 4. ç‰ˆæœ¬ç®¡ç†

æ›´æ–°ç‰ˆæœ¬å·ï¼š
1. ä¿®æ”¹ `package.json` ä¸­çš„ `version` å­—æ®µ
2. é‡æ–°æ‰“åŒ…
3. æ–°ç‰ˆæœ¬çš„åº”ç”¨ä¼šä½¿ç”¨æ–°çš„ç‰ˆæœ¬å·å‘½å

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ standalone æ¨¡å¼ï¼Ÿ

Next.js çš„ `standalone` è¾“å‡ºæ¨¡å¼ä¼šï¼š
- åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æœåŠ¡å™¨æ–‡ä»¶ï¼ˆ`server.js`ï¼‰
- åŒ…å«è¿è¡Œ Next.js åº”ç”¨æ‰€éœ€çš„æœ€å°ä¾èµ–
- ä½†ä¸åŒ…å«æ‰€æœ‰è¿è¡Œæ—¶ä¾èµ–ï¼ˆéœ€è¦æ‰‹åŠ¨è¡¥å……ï¼‰

### ä¸ºä»€ä¹ˆéœ€è¦ resolve-symlinksï¼Ÿ

pnpm ä½¿ç”¨ç¬¦å·é“¾æ¥æ¥ï¼š
- èŠ‚çœç£ç›˜ç©ºé—´
- å®ç°ä¾èµ–å…±äº«
- ä½†æ‰“åŒ…åçš„åº”ç”¨å¯èƒ½æ— æ³•æ­£ç¡®è§£æè¿™äº›é“¾æ¥

### ä¸ºä»€ä¹ˆä½¿ç”¨ fork è€Œä¸æ˜¯ spawnï¼Ÿ

- `fork` æ˜¯ `spawn` çš„ç‰¹æ®Šæƒ…å†µï¼Œä¸“é—¨ç”¨äº Node.js è„šæœ¬
- æä¾›æ›´å¥½çš„ IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰æ”¯æŒ
- è‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„æ‰§è¡Œç¯å¢ƒ
- æ›´é€‚åˆè¿è¡Œ Node.js æœåŠ¡å™¨è¿›ç¨‹

### ä¸ºä»€ä¹ˆç¦ç”¨ asarï¼Ÿ

- `asar` ä¼šå°†æ–‡ä»¶æ‰“åŒ…æˆå•ä¸ªå½’æ¡£æ–‡ä»¶
- ä½† Next.js æœåŠ¡å™¨éœ€è¦è®¿é—®çœŸå®çš„æ–‡ä»¶ç³»ç»Ÿ
- æŸäº› Node.js æ¨¡å—å¯èƒ½æ— æ³•ä» asar ä¸­æ­£ç¡®åŠ è½½
- å› æ­¤è®¾ç½®ä¸º `asar: false`

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶** - é€šå¸¸åŒ…å«è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
2. **æ‰‹åŠ¨æµ‹è¯•æœåŠ¡å™¨** - ç¡®è®¤é—®é¢˜æ˜¯å¦åœ¨æ‰“åŒ…è¿‡ç¨‹ä¸­
3. **æ£€æŸ¥ä¾èµ–** - ç¡®è®¤æ‰€æœ‰å¿…éœ€çš„æ¨¡å—éƒ½å·²åŒ…å«
4. **æ¸…ç†é‡å»º** - æœ‰æ—¶æ¸…ç†ç¼“å­˜å¯ä»¥è§£å†³é—®é¢˜

## ğŸ“š ç›¸å…³æ–‡ä»¶

### å‰ç«¯ç›¸å…³
- `electron/main.ts` - Electron ä¸»è¿›ç¨‹ä»£ç ï¼ˆåŒ…å«åç«¯å¯åŠ¨é€»è¾‘ï¼‰
- `electron-builder.yml` - electron-builder é…ç½®æ–‡ä»¶
- `scripts/resolve-symlinks.js` - ç¬¦å·é“¾æ¥è§£æè„šæœ¬
- `scripts/copy-missing-deps.js` - ç¼ºå¤±ä¾èµ–å¤åˆ¶è„šæœ¬
- `scripts/build-electron.js` - Electron ä¸»è¿›ç¨‹æ„å»ºè„šæœ¬
- `scripts/view-logs.sh` - æ—¥å¿—æŸ¥çœ‹è„šæœ¬
- `scripts/diagnose.sh` - è¯Šæ–­è„šæœ¬
- `next.config.mjs` - Next.js é…ç½®æ–‡ä»¶

### åç«¯ç›¸å…³
- `lifetrace/scripts/build-backend.sh` - åç«¯æ„å»ºè„šæœ¬ï¼ˆmacOS/Linuxï¼‰
- `lifetrace/scripts/build-backend.ps1` - åç«¯æ„å»ºè„šæœ¬ï¼ˆWindowsï¼‰
- `lifetrace/pyinstaller.spec` - PyInstaller é…ç½®æ–‡ä»¶
- `lifetrace/util/path_utils.py` - ç»Ÿä¸€è·¯å¾„å·¥å…·æ¨¡å—
- `lifetrace/scripts/start_backend.py` - åç«¯å¯åŠ¨åŒ…è£…è„šæœ¬

### æ–‡æ¡£
- `electron/æ‰“åŒ…æŒ‡å—.md` - æœ¬æ–‡æ¡£
- `electron/åç«¯å¯åŠ¨æ£€æŸ¥æŒ‡å—.md` - åç«¯å¯åŠ¨æ£€æŸ¥è¯¦ç»†è¯´æ˜

---

**æœ€åæ›´æ–°ï¼š** 2024-12-19  
**é€‚ç”¨ç‰ˆæœ¬ï¼š**
- Next.js 16.0.10
- Electron 39.2.7
- electron-builder 26.0.12
- PyInstaller 6.x
