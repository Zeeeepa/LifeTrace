# LifeTrace 完整打包指南（包含后端）

本文档详细描述如何将 LifeTrace 应用（前端 + 后端）打包为独立的桌面应用程序，特别针对 macOS 平台。

## 📋 目录

- [系统要求](#系统要求)
- [准备工作](#准备工作)
- [macOS 打包流程](#macos-打包流程)
- [打包流程详解](#打包流程详解)
- [验证打包结果](#验证打包结果)
- [常见问题与解决方案](#常见问题与解决方案)
- [其他平台打包](#其他平台打包)

## 系统要求

### macOS 打包要求

- **操作系统**: macOS 10.15 (Catalina) 或更高版本
- **架构支持**:
  - Apple Silicon (arm64) - M1/M2/M3 芯片
  - Intel (x64) - Intel 芯片
- **开发工具**:
  - Node.js 18+ 和 pnpm
  - Python 3.13+
  - PyInstaller 6.0+
  - Xcode Command Line Tools（用于代码签名，可选）

### 磁盘空间

- **构建过程**: 至少需要 10-15 GB 可用空间
  - Python 依赖（PyTorch 等）: ~5-8 GB
  - Node.js 依赖: ~500 MB
  - 构建产物: ~2-3 GB
- **最终应用**:
  - DMG 文件: ~1-2 GB（取决于架构）
  - 解压后应用: ~2-3 GB

## 准备工作

### 1. 安装依赖

#### 前端依赖

```bash
cd free-todo-frontend
pnpm install
```

#### 后端依赖

```bash
# 在项目根目录
# 使用 uv（推荐）
uv sync

# 或使用 pip
pip install -r requirements.txt

# 安装 PyInstaller（如果未安装）
pip install pyinstaller
# 或通过 uv
uv pip install pyinstaller
```

### 2. 配置环境变量（可选）

如果需要自定义端口或配置：

```bash
# 前端端口（默认 3000）
export PORT=3000

# 后端端口（默认 8000）
export BACKEND_PORT=8000
```

### 3. 清理之前的构建

```bash
# 清理前端构建
cd free-todo-frontend
rm -rf dist-electron-app dist-electron .next

# 清理后端构建
cd ../lifetrace
rm -rf dist build dist-backend
```

## macOS 打包流程

### 完整打包流程（推荐）

这是最简单的方式，一条命令完成所有步骤：

```bash
cd free-todo-frontend
pnpm electron:build-mac
```

这个命令会自动执行以下步骤：
1. 构建 Next.js 前端
2. 打包 Python 后端（PyInstaller）
3. 解析符号链接
4. 复制缺失依赖
5. 编译 Electron 主进程
6. 使用 electron-builder 创建 DMG

### 分步打包流程

如果需要更多控制或遇到问题，可以分步执行：

#### 步骤 1: 构建前端

```bash
cd free-todo-frontend
pnpm build
```

这会生成：
- `.next/standalone/` - Next.js 独立服务器
- `.next/static/` - 静态资源文件

#### 步骤 2: 打包后端

```bash
# 在 free-todo-frontend 目录
pnpm backend:build
```

或者直接在 lifetrace 目录：

```bash
cd ../lifetrace
bash scripts/build-backend.sh
```

这会：
- 使用 PyInstaller 打包 Python 后端
- 包含所有依赖（PyTorch、transformers 等）
- 包含 ONNX 模型文件
- 包含配置文件
- 输出到 `dist-backend/lifetrace/` 目录

**预期输出**：
```
Building LifeTrace backend...
Running PyInstaller...
Backend build complete! Output: /path/to/LifeTrace/dist-backend
Backend executable location: /path/to/LifeTrace/dist-backend/lifetrace
```

**构建时间**: 首次构建可能需要 10-30 分钟（取决于网络和 CPU），因为需要下载和编译大量 Python 依赖。

#### 步骤 3: 处理前端依赖

```bash
cd free-todo-frontend
pnpm electron:resolve-symlinks
pnpm electron:copy-missing-deps
```

这些脚本确保：
- pnpm 符号链接被解析为实际文件
- Next.js 运行时依赖完整

#### 步骤 4: 编译 Electron 主进程

```bash
pnpm electron:build-main
```

这会编译 TypeScript 主进程代码到 `dist-electron/main.js`。

#### 步骤 5: 创建安装包

```bash
electron-builder --mac
```

这会创建：
- `dist-electron-app/FreeTodo-0.1.0-mac-arm64.dmg` (Apple Silicon)
- `dist-electron-app/FreeTodo-0.1.0-mac-x64.dmg` (Intel)

## 打包流程详解

### 后端打包详解

#### PyInstaller 配置

后端使用 `lifetrace/pyinstaller.spec` 配置文件，采用 **one-folder** 打包方式（推荐用于大型依赖如 PyTorch）。

**打包内容**：
- Python 解释器和所有依赖
- FastAPI 服务器代码
- ONNX 模型文件（OCR）
- 配置文件模板
- 所有 Python 模块

**输出结构**：
```
dist-backend/lifetrace/
├── lifetrace                    # 可执行文件（主入口）
├── _internal/                   # Python 运行时和依赖
│   ├── python3.13/
│   ├── torch/
│   ├── transformers/
│   └── ...
├── config/                      # 配置文件
│   ├── default_config.yaml
│   ├── prompt.yaml
│   └── rapidocr_config.yaml
└── models/                      # ONNX 模型
    ├── ch_PP-OCRv4_det_infer.onnx
    ├── ch_PP-OCRv4_rec_infer.onnx
    └── ch_ppocr_mobile_v2.0_cls_infer.onnx
```

#### 后端启动流程

1. Electron 主进程启动后端可执行文件
2. 后端脚本 (`start_backend.py`) 执行：
   - 检查数据目录（`~/Library/Application Support/FreeTodo/lifetrace-data/`）
   - 初始化配置文件（如果不存在）
   - 启动 FastAPI 服务器（端口 8000）

### 前端打包详解

#### Next.js Standalone 构建

前端使用 Next.js 的 `standalone` 输出模式，生成自包含的服务器。

**构建输出**：
```
.next/
├── standalone/
│   ├── server.js              # 服务器入口
│   ├── .next/
│   │   └── server/            # 服务器端代码
│   └── node_modules/           # 运行时依赖
└── static/                    # 静态资源（CSS、JS chunks）
```

#### Electron 打包

electron-builder 将以下内容打包到应用：

```
FreeTodo.app/Contents/
├── MacOS/
│   └── FreeTodo               # Electron 可执行文件
├── Resources/
│   ├── app/
│   │   └── dist-electron/
│   │       └── main.js        # 主进程代码
│   ├── standalone/            # Next.js 服务器
│   └── backend/              # Python 后端
│       └── lifetrace/
│           └── lifetrace      # 后端可执行文件
└── ...
```

### 启动顺序

应用启动时的执行顺序：

1. **Electron 主进程启动**
   - 检查单实例锁定
   - 初始化日志系统

2. **后端服务器启动**（如果已打包）
   - 启动 PyInstaller 打包的后端可执行文件
   - 等待后端健康检查通过（最多 60 秒）

3. **前端服务器启动**
   - 启动 Next.js standalone 服务器
   - 等待前端服务器就绪（最多 30 秒）

4. **创建窗口**
   - 加载前端 URL (`http://localhost:3000`)
   - 显示应用窗口

## 验证打包结果

### 检查构建产物

```bash
# 检查后端
ls -lh dist-backend/lifetrace/lifetrace
# 应该显示可执行文件

# 检查前端
ls -lh dist-electron-app/*.dmg
# 应该显示 DMG 文件

# 检查 DMG 内容（挂载后）
open dist-electron-app/FreeTodo-0.1.0-mac-arm64.dmg
# 在 Finder 中检查应用结构
```

### 测试打包的应用

#### 方法 1: 从 DMG 安装测试

```bash
# 打开 DMG
open dist-electron-app/FreeTodo-0.1.0-mac-arm64.dmg

# 在 Finder 中：
# 1. 将 FreeTodo.app 拖到 Applications 文件夹
# 2. 打开 Applications/FreeTodo.app
# 3. 如果提示"无法打开，因为来自身份不明的开发者"：
#    - 系统设置 > 隐私与安全性 > 点击"仍要打开"
```

#### 方法 2: 直接运行（开发测试）

```bash
# 从构建目录直接运行
./dist-electron-app/mac/FreeTodo.app/Contents/MacOS/FreeTodo
```

### 验证功能

启动应用后，检查：

1. **后端服务**
   ```bash
   # 在终端检查后端是否运行
   curl http://localhost:8000/api/health
   # 应该返回 JSON 响应
   ```

2. **前端服务**
   ```bash
   # 检查前端是否运行
   curl http://localhost:3000
   # 应该返回 HTML
   ```

3. **应用窗口**
   - 窗口应该正常显示
   - 前端应该能连接到后端 API
   - 所有功能应该正常工作

4. **数据目录**
   ```bash
   # 检查数据目录是否创建
   ls -la ~/Library/Application\ Support/FreeTodo/lifetrace-data/
   # 应该包含 config/, data/, logs/ 目录
   ```

### 查看日志

如果遇到问题，查看日志：

```bash
# Electron 主进程日志
cat ~/Library/Logs/free-todo-frontend/freetodo.log

# 后端日志（在数据目录）
cat ~/Library/Application\ Support/FreeTodo/lifetrace-data/logs/*.log
```

## 常见问题与解决方案

### 问题 1: PyInstaller 构建失败

**症状**：
```
ModuleNotFoundError: No module named 'xxx'
```

**解决方案**：
1. 确保所有依赖已安装：
   ```bash
   cd lifetrace
   uv sync
   # 或
   pip install -r requirements.txt
   ```

2. 检查 `pyinstaller.spec` 中的 `hiddenimports` 列表，添加缺失的模块

3. 清理并重新构建：
   ```bash
   rm -rf dist build
   bash scripts/build-backend.sh
   ```

### 问题 2: 后端可执行文件找不到

**症状**：
```
Backend executable not found: /path/to/backend/lifetrace/lifetrace
```

**解决方案**：
1. 检查构建输出：
   ```bash
   ls -la dist-backend/lifetrace/
   ```

2. 确保构建脚本正确执行：
   ```bash
   cd lifetrace
   bash scripts/build-backend.sh
   ```

3. 检查 electron-builder.yml 配置：
   ```yaml
   extraResources:
     - from: 'dist-backend'
       to: 'backend'
   ```

### 问题 3: 后端启动超时

**症状**：
```
Backend server did not start within 60000ms
```

**解决方案**：
1. 检查后端日志：
   ```bash
   cat ~/Library/Application\ Support/FreeTodo/lifetrace-data/logs/*.log
   ```

2. 增加超时时间（在 `electron/main.ts` 中修改 `waitForBackend` 的超时参数）

3. 检查端口是否被占用：
   ```bash
   lsof -i :8000
   # 如果被占用，终止进程或更改端口
   ```

### 问题 4: 应用体积过大

**症状**：DMG 文件超过 2 GB

**原因**：PyTorch 和 transformers 库非常大

**解决方案**：
1. 使用 CPU-only 版本的 PyTorch（如果不需要 GPU）：
   ```bash
   pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
   ```

2. 排除不必要的依赖（在 `pyinstaller.spec` 的 `excludes` 中添加）

3. 考虑使用外部 Python 环境（不推荐，但可以减小体积）

### 问题 5: 代码签名问题（macOS）

**症状**：
```
"FreeTodo.app" cannot be opened because the developer cannot be verified
```

**解决方案**：

#### 选项 1: 临时允许（开发测试）
1. 系统设置 > 隐私与安全性
2. 点击"仍要打开"

#### 选项 2: 移除隔离属性
```bash
xattr -cr /Applications/FreeTodo.app
```

#### 选项 3: 代码签名（发布）
在 `electron-builder.yml` 中添加：

```yaml
mac:
  identity: "Developer ID Application: Your Name (TEAM_ID)"
  hardenedRuntime: true
  gatekeeperAssess: false
  entitlements: "build/entitlements.mac.plist"
  entitlementsInherit: "build/entitlements.mac.plist"
```

### 问题 6: 权限问题

**症状**：后端无法访问文件系统或网络

**解决方案**：
1. 检查应用权限（系统设置 > 隐私与安全性）
2. 确保数据目录可写：
   ```bash
   chmod -R 755 ~/Library/Application\ Support/FreeTodo/
   ```

### 问题 7: 架构不匹配

**症状**：在 Apple Silicon Mac 上构建了 x64 版本，或反之

**解决方案**：
1. 检查当前架构：
   ```bash
   uname -m
   # arm64 = Apple Silicon
   # x86_64 = Intel
   ```

2. 构建特定架构：
   ```bash
   # 只构建 arm64
   electron-builder --mac --arm64

   # 只构建 x64
   electron-builder --mac --x64

   # 构建两者（通用）
   electron-builder --mac
   ```

## 其他平台打包

### Windows

```bash
cd free-todo-frontend
pnpm electron:build-win
```

**注意事项**：
- 使用 PowerShell 脚本：`lifetrace/scripts/build-backend.ps1`
- 后端可执行文件：`lifetrace.exe`
- 可能需要处理 Windows Defender 误报

### Linux

```bash
cd free-todo-frontend
pnpm electron:build-linux
```

**注意事项**：
- 确保有执行权限：`chmod +x dist-backend/lifetrace/lifetrace`
- 可能需要安装额外的系统依赖

## 性能优化建议

### 构建时间优化

1. **使用缓存**：
   - PyInstaller 会缓存构建结果
   - 只修改代码时，重新构建会更快

2. **并行构建**（如果支持）：
   ```bash
   # 可以同时构建前端和后端（如果机器性能足够）
   pnpm build & pnpm backend:build &
   wait
   ```

### 应用启动优化

1. **后端启动时间**：
   - 首次启动较慢（模型加载）
   - 后续启动会更快（缓存）

2. **减少依赖**：
   - 只包含必要的 Python 包
   - 使用更轻量的替代方案（如果可能）

## 发布检查清单

在发布应用前，确保：

- [ ] 所有功能测试通过
- [ ] 后端和前端都能正常启动
- [ ] 数据目录正确创建
- [ ] 日志文件正常写入
- [ ] 应用图标正确显示
- [ ] 版本号正确（在 `package.json` 和 `pyproject.toml` 中）
- [ ] 代码签名（如果发布到 App Store 或需要公证）
- [ ] 文档更新（README、CHANGELOG）
- [ ] 在不同 macOS 版本上测试（如果可能）

## 高级配置

### 自定义后端端口

在 `electron/main.ts` 中修改：

```typescript
const BACKEND_PORT = process.env.BACKEND_PORT || "8000";
```

### 自定义数据目录

后端数据目录默认在 `app.getPath("userData")/lifetrace-data`，可以通过环境变量修改。

### 调试模式

开发时，可以在 `electron/main.ts` 中启用详细日志：

```typescript
const isDev = true; // 强制开发模式
```

## 获取帮助

如果遇到问题：

1. 查看日志文件
2. 检查 GitHub Issues
3. 查看文档
4. 联系开发团队

---

**最后更新**: 2024-12-17  
**适用版本**: LifeTrace 0.1.0
