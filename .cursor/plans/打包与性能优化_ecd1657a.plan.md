---
name: 打包与性能优化
overview: 针对启动速度、依赖效率和打包体积三个核心问题，评估 Tauri + Nuitka 方案，并提供依赖精简和模块剔除的具体实施方案。
todos:
  - id: remove-unused-deps
    content: 移除未使用依赖：faster-whisper, whisperlivekit, wikipedia, arxiv
    status: pending
  - id: update-pyinstaller-excludes
    content: 更新 PyInstaller excludes：添加测试模块、开发工具、文档等排除项
    status: pending
  - id: use-opencv-headless
    content: 替换 opencv-python 为 opencv-python-headless
    status: pending
  - id: update-electron-builder
    content: 更新 electron-builder.yml 排除 .d.ts、测试、文档等
    status: pending
  - id: refactor-dependency-groups
    content: 重构 pyproject.toml 创建 vector/imaging/search 依赖组
    status: pending
  - id: tauri-poc
    content: 创建 Tauri POC 分支验证与 Python 后端的 Sidecar 集成
    status: pending
  - id: nuitka-test
    content: 使用 Nuitka 编译后端并对比体积和启动速度
    status: pending
isProject: false
---

# 打包与性能系统优化计划

## 一、当前状态分析

### 打包架构现状

- **前端**: Electron + Next.js standalone（捆绑完整 Node.js 运行时）
- **后端**: PyInstaller one-folder bundle（捆绑 Python 解释器 + 所有依赖）
- **集成方式**: Electron 主进程启动 Python 后端进程

### 体积构成分析

| 组件 | 预估体积 | 主要贡献 |

|-----|---------|---------|

| Electron + Node.js | 150-200 MB | Node.js 运行时 |

| Next.js standalone | 100-150 MB | node_modules |

| Python 运行时 | 50-80 MB | Python 解释器 |

| torch + transformers | 2-3 GB | sentence-transformers 间接依赖 |

| chromadb | 100-200 MB | 向量数据库 |

| rapidocr + ONNX | 100-150 MB | OCR 核心 |

| opencv-python | 50-100 MB | 图像处理 |

| 其他依赖 | 200-300 MB | - |

**总计**: 约 2.8-4.2 GB

---

## 二、打包框架评估

### 方案 A: Tauri 替代 Electron（推荐评估）

**优势**:

- 使用系统原生 WebView，不捆绑 Chromium
- 典型应用体积 3-10 MB（对比 Electron 150+ MB）
- 启动速度更快，内存占用更低
- Rust 核心性能优秀

**与 Python 后端集成方式**:

1. **Sidecar 模式**（推荐）

                        - Python 后端作为独立进程运行
                        - Tauri 通过 HTTP/IPC 与后端通信
                        - 与当前架构兼容，迁移成本低
```
Tauri App
├── src-tauri/          # Rust 主进程
├── src/                # 前端代码（React/Next.js）
└── backend/            # Python 后端（Sidecar）
    └── lifetrace       # Nuitka/PyInstaller 打包
```


2. **PyTauri 模式**（可选）

                        - 通过 PyO3 将 Python 嵌入 Rust
                        - 需要较大重构，学习成本高

**迁移工作量评估**:

- 前端代码：基本无需修改（仍是 React）
- 构建配置：需重写（`electron-builder.yml` → `tauri.conf.json`）
- IPC 通信：需调整（Electron IPC → Tauri Commands）
- 后端启动逻辑：需重写（TypeScript → Rust）

**预估体积节省**: 150-200 MB（Electron → Tauri）

### 方案 B: Nuitka 替代 PyInstaller

**优势**:

- 将 Python 编译为 C 代码，运行时性能提升 2-4x
- 体积略小（22.5 MB vs 26.5 MB 基准测试）
- 更好的代码保护（编译后难以反编译）

**劣势**:

- 编译时间长（需要 C 编译器）
- 部分动态特性可能不兼容
- 对大型依赖（torch）的支持需验证

**Nuitka 配置示例**:

```bash
python -m nuitka \
    --standalone \
    --onefile \
    --enable-plugin=numpy \
    --enable-plugin=torch \
    --include-data-dir=config=config \
    --include-data-dir=models=models \
    --nofollow-import-to=tests \
    --nofollow-import-to=pytest \
    scripts/start_backend.py
```

**预估影响**:

- 体积：略有减少（5-15%）
- 启动速度：PyInstaller 的启动慢主要因为解压，Nuitka 可能改善
- 运行性能：提升 2-4x（对计算密集任务有益）

### 方案对比总结

| 方案 | 体积节省 | 启动提升 | 迁移成本 | 风险 |

|-----|---------|---------|---------|-----|

| Tauri 替代 Electron | 150-200 MB | 显著 | 中 | 低 |

| Nuitka 替代 PyInstaller | 50-100 MB | 中等 | 低 | 中 |

| **组合方案** | **200-300 MB** | **显著** | **中** | **中** |

---

## 三、依赖精简方案

### 核心功能依赖分析结果

| 依赖 | 体积 | 核心必需 | 懒加载 | 建议 |

|-----|------|---------|--------|-----|

| rapidocr-onnxruntime | 100-150 MB | **是** | 已实现 | 保留 |

| sentence-transformers | 2-3 GB | 否 | 已实现 | 可选扩展 |

| chromadb | 100-200 MB | 否 | 已实现 | 可选扩展 |

| opencv-python | 50-100 MB | 否 | 已实现 | 可选扩展 |

| faster-whisper | 200-500 MB | **否** | 未使用 | **移除** |

### 依赖分组重构

修改 [`pyproject.toml`](pyproject.toml)：

```toml
[project]
dependencies = [
    # === 核心依赖（必需）===
    # Web 框架
    "fastapi>=0.100.0",
    "uvicorn[standard]>=0.20.0",
    "pydantic>=2.0.0",
    "python-multipart>=0.0.6",
    # 数据库
    "sqlalchemy>=2.0.0",
    "sqlmodel>=0.0.22",
    "alembic>=1.14.0",
    # 配置与工具
    "dynaconf[yaml]>=3.2.0",
    "pyyaml>=6.0",
    "loguru>=0.7.3",
    "apscheduler>=3.10.0",
    "psutil>=5.9.0",
    # LLM
    "openai>=1.0.0",
    "agno>=2.4.1",
    # OCR 核心
    "mss>=9.0.0",
    "Pillow>=10.0.0",
    "rapidocr-onnxruntime",
    "numpy>=1.21.0,<2.0.0",
    "imagehash>=4.3.0",
]

[dependency-groups]
# 开发依赖
dev = ["pre-commit>=4.4.0", "ruff>=0.14.4", "pyinstaller>=6.0.0"]

# 向量搜索扩展（可选下载）
vector = [
    "sentence-transformers>=2.2.0",
    "chromadb>=0.4.0",
    "scipy>=1.9.0",
    "hdbscan>=0.8.0",
]

# 图像处理增强（可选）
imaging = [
    "opencv-python-headless>=4.8.0",  # 使用 headless 版本减小体积
]

# 搜索工具（可选）
search = [
    "ddgs>=8.0.0",
    "tavily-python>=0.5.0",
]
```

### 功能降级策略

当可选依赖缺失时，功能优雅降级：

| 缺失依赖 | 影响功能 | 降级方案 |

|---------|---------|---------|

| sentence-transformers | 语义搜索 | 显示提示"需安装向量扩展"，使用 SQLite FTS 全文搜索 |

| chromadb | 向量存储 | 同上 |

| opencv-python | 图像缩放 | 跳过预处理，直接 OCR |

代码中已有懒加载实现（[`llm/vector_db.py`](lifetrace/llm/vector_db.py)），缺失时不会崩溃。

---

## 四、模块剔除清单

### PyInstaller excludes 更新

修改 [`pyinstaller.spec`](lifetrace/pyinstaller.spec)：

```python
excludes = [
    # 现有排除项
    "matplotlib", "tkinter", "pytest", "test", "tests",

    # === 开发工具 ===
    "pre_commit", "ruff", "black", "mypy", "pylint", "flake8",

    # === 文档生成 ===
    "sphinx", "mkdocs", "pydoc", "docutils",

    # === 测试框架 ===
    "nose", "coverage", "hypothesis", "unittest.mock",

    # === 包管理 ===
    "setuptools", "wheel", "pip", "distutils", "ensurepip",

    # === Jupyter/IPython ===
    "jupyter", "ipython", "notebook", "ipykernel",

    # === 不需要的标准库 ===
    "curses",      # 终端 UI（GUI 应用不需要）
    "readline",    # 交互式命令行
    "turtle",      # 图形库
    "idlelib",     # IDLE IDE
    "lib2to3",     # Python 2→3 转换工具
    "pydoc_data",  # pydoc 数据

    # === 依赖包的测试模块 ===
    "numpy.tests", "numpy.f2py.tests",
    "scipy.tests",
    "torch.testing", "torch.utils.benchmark",
    "transformers.tests",
    "sentence_transformers.tests",
    "chromadb.tests",
    "sqlalchemy.testing",
    "pydantic.tests",
]
```

### 移除未使用的依赖

从 `pyproject.toml` 中移除：

```toml
# 以下依赖代码中未使用，建议移除
# "faster-whisper>=1.0.0"      # 未找到导入
# "whisperlivekit>=0.1.0"      # 未找到导入
# "wikipedia>=1.4.0"           # 未找到导入
# "arxiv>=2.4.0"               # 未找到导入
# "python-socks>=2.0.0"        # websockets 可选依赖，如不需代理可移除
```

### 前端优化

更新 [`electron-builder.yml`](free-todo-frontend/electron-builder.yml)：

```yaml
files:
 - "dist-electron/**/*"
 - "!**/*.d.ts"           # 排除 TypeScript 类型定义
 - "!**/test/**"          # 排除测试目录
 - "!**/tests/**"
 - "!**/__tests__/**"
 - "!**/__mocks__/**"
 - "!**/node_modules/.bin/**"  # 排除 CLI 工具
 - "!**/*.md"             # 排除文档
 - "!**/*.map"            # 排除 source maps
```

---

## 五、实施路线图

### 阶段 1: 快速优化（立即可做）

1. **移除未使用依赖**

                        - 删除 `faster-whisper`, `whisperlivekit`, `wikipedia`, `arxiv`
                        - 预估节省：300-700 MB

2. **更新 PyInstaller excludes**

                        - 添加测试模块、开发工具等排除项
                        - 预估节省：100-200 MB

3. **使用 opencv-python-headless**

                        - 替换 `opencv-python` → `opencv-python-headless`
                        - 预估节省：30-50 MB

4. **前端构建优化**

                        - 更新 electron-builder 排除规则
                        - 预估节省：50-100 MB

**阶段 1 预估效果**: 节省 480-1050 MB

### 阶段 2: 依赖分组（中期）

1. **重构 pyproject.toml**

                        - 创建 `vector`, `imaging`, `search` 依赖组
                        - 核心包只保留必需依赖

2. **调整打包脚本**

                        - 基础包：不含 sentence-transformers/chromadb
                        - 完整包：包含所有可选依赖

3. **添加运行时检测**

                        - 缺失可选依赖时显示安装提示

**阶段 2 预估效果**: 基础包可减至 500-800 MB

### 阶段 3: 框架迁移评估（长期）

1. **Tauri POC**

                        - 创建 Tauri 分支进行技术验证
                        - 测试与 Python 后端的 Sidecar 集成
                        - 评估迁移工作量

2. **Nuitka 测试**

                        - 使用 Nuitka 编译后端
                        - 对比体积和启动速度
                        - 验证所有功能正常

3. **决策点**

                        - 如果 Tauri + Nuitka 效果显著，进行完整迁移
                        - 否则保持现有架构，继续优化

---

## 六、预期结果

| 指标 | 当前 | 阶段1后 | 阶段2后 | 阶段3后(预估) |

|-----|------|--------|--------|--------------|

| Mac 体积 | 2.6 GB | 1.8-2.1 GB | 500-800 MB | 300-500 MB |

| Windows 体积 | 3 GB | 2.0-2.5 GB | 600-900 MB | 400-600 MB |

| 启动时间 | 4 秒 | 3 秒 | 2 秒 | 1 秒内 |

---

## 七、风险与注意事项

1. **功能完整性**: 移除依赖前需验证代码中确实未使用
2. **用户体验**: 可选依赖缺失时需有清晰的安装引导
3. **Tauri 迁移**: 需要学习 Rust，IPC 通信方式需调整
4. **Nuitka 兼容性**: 部分动态 Python 特性可能不兼容
5. **测试覆盖**: 每个阶段完成后需全面测试功能
