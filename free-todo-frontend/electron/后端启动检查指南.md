# 后端启动检查指南

## 后端在构建中的位置

是的，后端完全包含在 `dist-electron-app` 构建内容中。

### 构建后的目录结构

```
FreeTodo.app/Contents/Resources/
├── app/                    # Electron 主应用
├── backend/                # Python 后端（PyInstaller 打包）
│   ├── lifetrace          # 后端可执行文件
│   ├── _internal/         # PyInstaller 依赖
│   ├── config/            # 配置文件（default_config.yaml, prompt.yaml, rapidocr_config.yaml）
│   └── models/            # ONNX 模型文件
└── standalone/            # Next.js standalone 服务器
```

### 验证后端是否在构建中

```bash
# 检查后端可执行文件
ls -la dist-electron-app/mac-arm64/FreeTodo.app/Contents/Resources/backend/lifetrace

# 检查后端目录结构
ls -la dist-electron-app/mac-arm64/FreeTodo.app/Contents/Resources/backend/
```

## 如何知道后端是否启动

### 1. 查看 Electron 日志

后端启动信息会记录在 Electron 主进程日志中：

**macOS 日志位置：**
```bash
~/Library/Logs/free-todo-frontend/freetodo.log
```

**快速查看日志：**
```bash
# 使用项目提供的脚本
cd free-todo-frontend
bash scripts/view-logs.sh

# 或直接查看
tail -f ~/Library/Logs/free-todo-frontend/freetodo.log
```

**日志中的关键信息：**
- `Starting backend server...` - 开始启动后端
- `Backend path: ...` - 后端可执行文件路径
- `Backend directory: ...` - 后端工作目录
- `Data directory: ...` - 数据目录路径
- `[Backend STDOUT] ...` - 后端标准输出
- `[Backend STDERR] ...` - 后端标准错误输出
- `Backend server is ready!` - 后端启动成功
- `Backend health check passed: ...` - 后端健康检查通过

### 2. 查看后端应用日志

后端应用自己的日志位于用户数据目录：

**macOS 日志位置：**
```bash
~/Library/Application Support/free-todo-frontend/lifetrace-data/logs/
```

**查看后端日志：**
```bash
# 使用项目提供的脚本（同时查看 Electron 和后端日志）
bash scripts/view-logs.sh

# 或直接查看后端日志
ls ~/Library/Application\ Support/free-todo-frontend/lifetrace-data/logs/
tail -f ~/Library/Application\ Support/free-todo-frontend/lifetrace-data/logs/*.log
```

### 3. 检查后端进程

**macOS：**
```bash
# 查看 lifetrace 进程
ps aux | grep lifetrace

# 查看端口占用（后端默认端口 8000）
lsof -i :8000
```

### 4. 检查后端健康端点

后端提供健康检查端点：`http://localhost:8000/health`

**使用 curl 测试：**
```bash
curl http://localhost:8000/health
```

**预期响应：**
- 状态码：200 或 2xx/3xx
- 响应体：JSON 格式的健康状态信息

### 5. 使用诊断脚本

项目提供了诊断脚本，可以全面检查应用状态：

```bash
cd free-todo-frontend
bash scripts/diagnose.sh
```

该脚本会检查：
- Electron 日志
- 后端数据目录和日志
- 运行中的进程
- 端口状态（3000, 8000）
- 应用包结构

## 启动流程

应用启动时的顺序：

1. **启动后端服务器** (`startBackendServer()`)
   - 查找后端可执行文件
   - 启动后端进程
   - 设置数据目录

2. **等待后端就绪** (`waitForBackend()`)
   - 轮询 `http://localhost:8000/health`
   - 超时时间：180 秒（3 分钟）
   - 每 500ms 检查一次

3. **启动后端健康检查** (`startBackendHealthCheck()`)
   - 每 30 秒检查一次后端健康状态
   - 记录警告到日志

4. **启动 Next.js 服务器** (`startNextServer()`)

5. **等待 Next.js 就绪** (`waitForServer()`)
   - 超时时间：30 秒

6. **启动 Next.js 健康检查** (`startHealthCheck()`)

7. **创建窗口** (`createWindow()`)

## 常见问题排查

### 后端启动失败

**检查点：**
1. 后端可执行文件是否存在？
   ```bash
   ls -la /Applications/FreeTodo.app/Contents/Resources/backend/lifetrace
   ```

2. 后端是否有执行权限？
   ```bash
   chmod +x /Applications/FreeTodo.app/Contents/Resources/backend/lifetrace
   ```

3. 查看 Electron 日志中的错误信息：
   ```bash
   tail -100 ~/Library/Logs/free-todo-frontend/freetodo.log | grep -i backend
   ```

4. 查看后端日志：
   ```bash
   tail -100 ~/Library/Application\ Support/free-todo-frontend/lifetrace-data/logs/*.log
   ```

### 后端启动但健康检查失败

**可能原因：**
- 后端启动时间较长（需要加载模型等）
- 端口被占用
- 配置文件缺失

**解决方法：**
- 检查日志中的具体错误信息
- 确认端口 8000 未被其他程序占用
- 检查配置文件是否存在：
  ```bash
  ls -la ~/Library/Application\ Support/free-todo-frontend/lifetrace-data/config/
  ```

### 后端进程意外退出

**检查点：**
1. 查看后端 STDERR 输出（在 Electron 日志中）
2. 查看后端应用日志
3. 检查系统资源（内存、磁盘空间）

## 环境变量

可以通过环境变量控制后端行为：

- `BACKEND_PORT`: 后端服务端口（默认：8000）
- `LIFETRACE_DATA_DIR`: 后端数据目录（默认：`~/Library/Application Support/free-todo-frontend/lifetrace-data`）

## 总结

**如何确认后端已启动：**

1. ✅ 查看 Electron 日志：`~/Library/Logs/free-todo-frontend/freetodo.log`
   - 查找 `Backend server is ready!`

2. ✅ 查看后端日志：`~/Library/Application Support/free-todo-frontend/lifetrace-data/logs/`

3. ✅ 检查进程：`ps aux | grep lifetrace`

4. ✅ 测试健康端点：`curl http://localhost:8000/health`

5. ✅ 使用诊断脚本：`bash scripts/diagnose.sh`

**后端位置：**
- ✅ 完全包含在构建后的 `.app` 包中
- ✅ 路径：`FreeTodo.app/Contents/Resources/backend/`
- ✅ 包含可执行文件、依赖、配置和模型
